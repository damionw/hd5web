#! /usr/bin/env bash

http::hdf5::url_mappings() {
    url::add_handler '^\/$' GET http::hdf5::response_index
    url::add_handler '^\/index.html$' GET http::hdf5::response_index
    url::add_handler '^\/api\/files[\/]*$' GET http::hdf5::get_filelist
    url::add_handler '^\/api\/tree[\/]*$' GET http::hdf5::get_tree
    url::add_handler '^\/static\/.*$' GET http::response_file
}

http::hdf5::importlib() {
    . "$("${__HD5WEB_BINARY__}" --lib)"
}

http::hdf5::response_index() {
    http::response_file GET index.html "${3}"
}

http::hdf5::get_filelist() {
    http::hdf5::importlib

    hdf5::files | {
        echo "{"
        echo "\"files\": ["
        awk '{printf("%s\"%s\"\n", sep, $0); sep=",";}'
        echo "]"
        echo "}"
    } | http::response_json
}

http::hdf5::get_tree() {
    local _descriptor=
    local _fs1=

    http::hdf5::importlib

    echo "{"
    echo "\"nodes\": ["

    hdf5::files | hdf5::map hdf5::dir | while read _descriptor
    do
        eval "${_descriptor}"

        local _pathnodes="$(
            echo "root${path}" | awk -F/ '{
                for (i=1; i <= NF; ++i) {
                    if (length($i) > 0) {
                        print $i;
                    }
                }
            }'
        )"

        local _path_elements="$(
            echo "["
            echo "${_pathnodes}" | awk '{printf("%s\"%s\"", sep, $0); sep=",";}'
            echo "]"
        )"

        local _parent_elements="$(
            echo "["
            echo "${_pathnodes}" | head --lines=-1 | awk '{printf("%s\"%s\"", sep, $0); sep=",";}'
            echo "]"
        )"

        local _parent="$(
            echo "${_pathnodes}" |
            head --lines=-1 |
            awk '{printf("%s%s", sep, (NR > 1 ? $0 : "/")); if (NR > 1) {sep="/";}}'
        )"

        echo "${_fs1}{"
        echo "\"filename\": \"${filename}\""
        echo ",\"path\": \"${path}\""
        echo ",\"parent\": \"${_parent}\""
        echo ",\"type\": \"${type}\""
        echo ",\"path_elements\": ${_path_elements}"
        echo ",\"parent_elements\": ${_parent_elements}"
        echo "}"

        _fs1=","
    done

    echo "]"
    echo "}"
}